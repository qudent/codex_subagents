#!/usr/bin/env bash
# wtx entrypoint coordinating split modules

set -euo pipefail
IFS=$'\n\t'

SCRIPT_DIR=$(CDPATH= cd -- "$(dirname "${BASH_SOURCE[0]}" )" && pwd)
WTX_LIB_DIR="$SCRIPT_DIR/wtx-lib"

. "$WTX_LIB_DIR/common.sh"
. "$WTX_LIB_DIR/args.sh"
. "$WTX_LIB_DIR/state.sh"
. "$WTX_LIB_DIR/messaging.sh"
. "$WTX_LIB_DIR/mux.sh"
. "$WTX_LIB_DIR/close.sh"
. "$WTX_LIB_DIR/prune.sh"
. "$WTX_LIB_DIR/launch.sh"

wtx_main() {
  wtx_parse_args "$@"
  wtx_init_repo_context

  case "$SUBCOMMAND" in
    close)
      if [ -z "${CLOSE_BRANCH:-}" ]; then
        current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo detached)
        [ "$current_branch" = "detached" ] || [ "$current_branch" = "HEAD" ] || CLOSE_BRANCH="$current_branch"
      fi
      [ -n "${CLOSE_BRANCH:-}" ] || die "unable to resolve branch to close"
      wtx_close_branch "$CLOSE_BRANCH" "$CLOSE_MODE"
      return
      ;;
    prune)
      wtx_prune_command
      return
      ;;
  esac

  wtx_launch_branch
}

wtx_main "$@"
